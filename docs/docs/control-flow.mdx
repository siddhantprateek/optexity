---
title: Control Flow
description: Loops and conditional logic in automations
---

Optexity supports control flow structures for building dynamic automations that can iterate over data and make decisions based on conditions.

## Overview

Two control flow nodes are available:

| Node Type | Purpose |
|-----------|---------|
| `ForLoopNode` | Iterate over a list of values |
| `IfElseNode` | Conditional execution based on a condition |

Both can be used alongside `ActionNode` in your automation's `nodes` list.

## ForLoopNode

Use `ForLoopNode` to iterate over values in a parameter. This is essential for processing lists of items like search results, order IDs, or table rows.

### Basic Syntax

```python
from optexity.schema.automation import ForLoopNode, ActionNode

ForLoopNode(
    variable_name="items",  # The variable to iterate over
    nodes=[
        # Actions to perform for each item
        ActionNode(...),
        ActionNode(...),
    ],
)
```

### How It Works

1. Before the loop, populate the variable using an extraction action
2. The loop iterates once for each value in the variable
3. Inside the loop, use `{variable_name[index]}` to access the current value

### Complete Example

```python
from optexity.schema.automation import (
    Automation, ActionNode, ForLoopNode, Parameters
)
from optexity.schema.actions.extraction_action import (
    ExtractionAction, LLMExtraction
)
from optexity.schema.actions.interaction_action import (
    InteractionAction, ClickElementAction, GoBackAction
)

order_scraper = Automation(
    url="https://orders.example.com",
    parameters=Parameters(
        input_parameters={},
        generated_parameters={
            "order_ids": [],  # Will be populated by extraction
        },
    ),
    nodes=[
        # Step 1: Extract all order IDs
        ActionNode(
            extraction_action=ExtractionAction(
                llm=LLMExtraction(
                    source=["axtree"],
                    extraction_format={"order_ids": "List[str]"},
                    extraction_instructions="Extract all order IDs from the orders table",
                    output_variable_names=["order_ids"],
                )
            )
        ),
        
        # Step 2: Loop through each order
        ForLoopNode(
            variable_name="order_ids",
            nodes=[
                # Click on the order
                ActionNode(
                    interaction_action=InteractionAction(
                        click_element=ClickElementAction(
                            command="""get_by_text("{order_ids[index]}")""",
                            prompt_instructions="Click on order {order_ids[index]}",
                        )
                    )
                ),
                
                # Extract order details
                ActionNode(
                    extraction_action=ExtractionAction(
                        llm=LLMExtraction(
                            source=["axtree"],
                            extraction_format={
                                "status": "str",
                                "total": "str",
                                "items": "List[str]",
                            },
                            extraction_instructions="Extract order details",
                        )
                    )
                ),
                
                # Go back to the list
                ActionNode(
                    interaction_action=InteractionAction(
                        go_back=GoBackAction()
                    )
                ),
            ],
        ),
    ],
)
```

### The `index` Variable

Inside a `ForLoopNode`, `index` is a special variable that represents the current iteration:

```python
# If order_ids = ["ORD-001", "ORD-002", "ORD-003"]

# First iteration: index = 0
"{order_ids[index]}" → "ORD-001"

# Second iteration: index = 1
"{order_ids[index]}" → "ORD-002"

# Third iteration: index = 2
"{order_ids[index]}" → "ORD-003"
```

### Using Index in Commands

```python
ForLoopNode(
    variable_name="product_names",
    nodes=[
        ActionNode(
            interaction_action=InteractionAction(
                click_element=ClickElementAction(
                    # Variable in command
                    command="""get_by_role("link", name="{product_names[index]}")""",
                    # Variable in prompt
                    prompt_instructions="Click on product {product_names[index]}",
                )
            )
        ),
    ],
)
```

### Nested Loops

You can nest `ForLoopNode` structures, but each must use a different variable:

```python
# Extract categories
ActionNode(
    extraction_action=ExtractionAction(
        llm=LLMExtraction(
            extraction_format={"categories": "List[str]"},
            output_variable_names=["categories"],
            ...
        )
    )
),

# Loop through categories
ForLoopNode(
    variable_name="categories",
    nodes=[
        # Click category
        ActionNode(
            interaction_action=InteractionAction(
                click_element=ClickElementAction(
                    command="""get_by_text("{categories[index]}")""",
                    ...
                )
            )
        ),
        
        # Extract products in this category
        ActionNode(
            extraction_action=ExtractionAction(
                llm=LLMExtraction(
                    extraction_format={"products": "List[str]"},
                    output_variable_names=["products"],
                    ...
                )
            )
        ),
        
        # Loop through products
        ForLoopNode(
            variable_name="products",
            nodes=[
                ActionNode(
                    interaction_action=InteractionAction(
                        click_element=ClickElementAction(
                            prompt_instructions="Click on product {products[index]}",
                            ...
                        )
                    )
                ),
                # Process each product...
            ],
        ),
    ],
)
```

<Warning>
When using nested loops, the inner loop's variable is overwritten each time. Make sure to process data before moving to the next outer iteration.
</Warning>

## IfElseNode

Use `IfElseNode` for conditional execution based on a condition string.

### Basic Syntax

```python
from optexity.schema.automation import IfElseNode, ActionNode

IfElseNode(
    condition="condition_name",
    if_nodes=[
        # Actions if condition is true
        ActionNode(...),
    ],
    else_nodes=[
        # Actions if condition is false (optional)
        ActionNode(...),
    ],
)
```

### Example

```python
IfElseNode(
    condition="has_captcha",
    if_nodes=[
        # Handle captcha
        ActionNode(
            interaction_action=InteractionAction(
                agentic_task=AgenticTask(
                    task="Solve the captcha",
                    max_steps=10,
                    backend="browser_use",
                )
            )
        ),
    ],
    else_nodes=[
        # No captcha, proceed normally
        ActionNode(
            interaction_action=InteractionAction(
                click_element=ClickElementAction(
                    command="""get_by_role("button", name="Continue")""",
                    prompt_instructions="Click continue",
                )
            )
        ),
    ],
)
```

### Else Nodes Are Optional

If you only need to act when a condition is true:

```python
IfElseNode(
    condition="needs_verification",
    if_nodes=[
        # Only execute if verification needed
        ActionNode(...),
    ],
    else_nodes=[],  # Empty - do nothing otherwise
)
```

## Common Patterns

### Process All Items in a Table

```python
# 1. Extract item identifiers
ActionNode(
    extraction_action=ExtractionAction(
        llm=LLMExtraction(
            extraction_format={"item_ids": "List[str]"},
            output_variable_names=["item_ids"],
            extraction_instructions="Extract all item IDs from the table",
            source=["axtree"],
        )
    )
),

# 2. Process each item
ForLoopNode(
    variable_name="item_ids",
    nodes=[
        # Click item
        ActionNode(
            interaction_action=InteractionAction(
                click_element=ClickElementAction(
                    command="""get_by_text("{item_ids[index]}")""",
                    prompt_instructions="Click on item {item_ids[index]}",
                )
            )
        ),
        # Extract/process
        ActionNode(...),
        # Return to list
        ActionNode(
            interaction_action=InteractionAction(
                go_back=GoBackAction()
            )
        ),
    ],
)
```

### Paginated Results

```python
# For each page (assuming you extracted page numbers)
ForLoopNode(
    variable_name="page_numbers",
    nodes=[
        # Go to page
        ActionNode(
            interaction_action=InteractionAction(
                click_element=ClickElementAction(
                    command="""get_by_text("{page_numbers[index]}")""",
                    prompt_instructions="Click page {page_numbers[index]}",
                )
            )
        ),
        # Extract items from this page
        ActionNode(
            extraction_action=ExtractionAction(...)
        ),
    ],
)
```

### Download Multiple Files

```python
ForLoopNode(
    variable_name="document_links",
    nodes=[
        ActionNode(
            interaction_action=InteractionAction(
                click_element=ClickElementAction(
                    command="""get_by_role("link", name="{document_links[index]}")""",
                    prompt_instructions="Click to download {document_links[index]}",
                    expect_download=True,
                )
            )
        ),
    ],
)
```

## Limitations

- `ForLoopNode` requires the variable to be populated before the loop executes
- Variables in loops are replaced at runtime, so dynamic commands must use the `{var[index]}` syntax
- Nested loops can be complex; consider breaking into separate automations for clarity

## Next Steps

- Learn about [Extraction Actions](/docs/extraction-actions) to populate loop variables
- See [Parameters & Variables](/docs/parameters-variables) for variable syntax
- Check [Best Practices](/docs/best-practices) for tips on complex automations

